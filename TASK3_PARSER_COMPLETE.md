# Task 3: Parser Module - å®ŒæˆæŠ¥å‘Š

## ğŸ‰ å®Œæˆæ—¥æœŸ
2025å¹´10æœˆ16æ—¥

## âœ… ä»»åŠ¡ç›®æ ‡
å®ç°æ•°æ®è§£ææ¨¡å—ï¼Œå°†åŸå§‹JSONå¯¹è±¡è½¬æ¢ä¸ºéªŒè¯è¿‡çš„Pydanticæ¨¡å‹ã€‚

---

## ğŸ“¦ å®ç°å†…å®¹

### æ¨¡å—: `src/v2aix_pipeline/parser.py` (çº¦550è¡Œ)

#### 1. **æ—¶é—´æˆ³å·¥å…·** (Timestamp Utilities)

**`detect_timestamp_unit(timestamp)`**
- è‡ªåŠ¨æ£€æµ‹æ—¶é—´æˆ³å•ä½ï¼ˆç§’/æ¯«ç§’/å¾®ç§’ï¼‰
- åŸºäºæ•°å€¼å¤§å°çš„å¯å‘å¼ç®—æ³•
- æ”¯æŒUnixæ—¶é—´æˆ³èŒƒå›´ (2001-2286å¹´)

**`normalize_timestamp(timestamp, unit)`**
- å°†æ‰€æœ‰æ—¶é—´æˆ³æ ‡å‡†åŒ–ä¸ºæ¯«ç§’ï¼ˆUTCï¼‰
- æ”¯æŒæ˜¾å¼å•ä½æŒ‡å®šæˆ–è‡ªåŠ¨æ£€æµ‹
- å¤„ç†ç§’ (Ã—1000)ã€æ¯«ç§’ (ä¸å˜)ã€å¾®ç§’ (Ã·1000)

```python
# ç¤ºä¾‹
normalize_timestamp(1678901234)       # ç§’ â†’ 1678901234000
normalize_timestamp(1678901234000)    # æ¯«ç§’ â†’ 1678901234000
normalize_timestamp(1678901234000000) # å¾®ç§’ â†’ 1678901234000
```

#### 2. **å­—æ®µæå–å·¥å…·** (Field Extraction Utilities)

æ”¯æŒå¤šç§å­—æ®µå‘½åçº¦å®šçš„æå–å‡½æ•°ï¼š

| åŠŸèƒ½ | æ”¯æŒçš„å­—æ®µå |
|------|-------------|
| `extract_vehicle_id()` | stationID, station_id, vehicleID, vehicle_id, id |
| `extract_latitude()` | latitude, lat, latitude_deg |
| `extract_longitude()` | longitude, lon, longitude_deg |
| `extract_altitude()` | altitude, alt, altitude_m |
| `extract_speed()` | speed, speed_mps, speedMps |
| `extract_heading()` | heading, heading_deg, headingDeg |
| `extract_message_type()` | messageType, message_type, msgType |
| `extract_direction()` | direction (è½¬æ¢ä¸ºDirectionæšä¸¾) |
| `extract_rsu_id()` | rsu_id, rsuID, rsuId |
| `extract_station_type()` | stationType, station_type |

**ç‰¹æ€§**:
- è‡ªåŠ¨å°è¯•å¤šä¸ªå­—æ®µåå˜ä½“
- ç±»å‹è½¬æ¢ï¼ˆå­—ç¬¦ä¸²ã€æµ®ç‚¹æ•°ã€æ•´æ•°ï¼‰
- è¿”å›Noneè¡¨ç¤ºå­—æ®µç¼ºå¤±

#### 3. **GNSSè®°å½•è§£æå™¨**

**`parse_gnss_record(obj, source_file, timestamp_unit)`**

è§£æJSONå¯¹è±¡ä¸º`GnssRecord` Pydanticæ¨¡å‹ã€‚

**å¿…éœ€å­—æ®µ**:
- vehicle_id (æ¥è‡ªå¤šä¸ªæ¥æº)
- timestamp
- latitude
- longitude

**å¯é€‰å­—æ®µ**:
- altitude, speed, heading
- station_id, station_type
- source_file

**è¡Œä¸º**:
- ç¼ºå°‘å¿…éœ€å­—æ®µè¿”å›`None`
- è®°å½•è°ƒè¯•æ—¥å¿—è¯´æ˜è·³è¿‡åŸå› 
- æ•è·å¹¶è®°å½•PydanticéªŒè¯é”™è¯¯

#### 4. **V2Xæ¶ˆæ¯è§£æå™¨**

**`parse_v2x_record(obj, source_file, timestamp_unit)`**

è§£æJSONå¯¹è±¡ä¸º`V2XMessageRecord` Pydanticæ¨¡å‹ã€‚

**å¿…éœ€å­—æ®µ**:
- vehicle_id

**å¯é€‰å­—æ®µï¼ˆä½†è‡³å°‘åº”æœ‰ä¸€ä¸ªæ—¶é—´æˆ³ï¼‰**:
- timestamp, tx_timestamp, rx_timestamp
- message_type
- direction (uplink_to_rsu, downlink_from_rsu, v2v)
- rsu_id
- payload_bytes, frame_bytes
- station_id, station_type

**è‡ªåŠ¨è®¡ç®—**:
- **latency_ms**: å¦‚æœtxå’Œrxæ—¶é—´æˆ³éƒ½å­˜åœ¨ï¼Œè‡ªåŠ¨è®¡ç®— `latency = rx - tx`

**è¡Œä¸º**:
- æ¯”GNSSè§£ææ›´å®½æ¾ï¼ˆåªéœ€vehicle_idï¼‰
- å…è®¸æ‰€æœ‰å¯é€‰å­—æ®µä¸ºNone

#### 5. **æ‰¹é‡è§£æ**

**`parse_records(objects, source_file, timestamp_unit)`**

æ‰¹é‡è§£æJSONå¯¹è±¡åˆ—è¡¨ã€‚

**ç‰¹æ€§**:
- è‡ªåŠ¨æ£€æµ‹è®°å½•ç±»å‹
- ä¸€ä¸ªå¯¹è±¡å¯ä»¥åŒæ—¶ä½œä¸ºGNSSå’ŒV2Xè§£æï¼ˆå¦‚æœåŒ…å«ä¸¤è€…çš„å­—æ®µï¼‰
- è¿”å›å…ƒç»„ `(gnss_records, v2x_records)`
- è·³è¿‡éå­—å…¸å¯¹è±¡
- è®°å½•INFOçº§åˆ«çš„æ±‡æ€»æ—¥å¿—

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•è¦†ç›–

âœ… **æµ‹è¯•1**: æ—¶é—´æˆ³å•ä½æ£€æµ‹
- ç§’: 1678901234 â†’ 'seconds'
- æ¯«ç§’: 1678901234000 â†’ 'milliseconds'
- å¾®ç§’: 1678901234000000 â†’ 'microseconds'

âœ… **æµ‹è¯•2**: æ—¶é—´æˆ³æ ‡å‡†åŒ–
- æ‰€æœ‰æ ¼å¼æ­£ç¡®è½¬æ¢ä¸ºæ¯«ç§’

âœ… **æµ‹è¯•3**: GNSSè®°å½•è§£æ
- æ‰€æœ‰å­—æ®µæ­£ç¡®æå–
- æ—¶é—´æˆ³è‡ªåŠ¨æ ‡å‡†åŒ–
- source_fileæ­£ç¡®å…³è”

âœ… **æµ‹è¯•4**: V2Xè®°å½•è§£æ
- æ¶ˆæ¯ç±»å‹ã€æ–¹å‘ã€RSU IDæ­£ç¡®
- å»¶è¿Ÿè‡ªåŠ¨è®¡ç®— (20msç¤ºä¾‹é€šè¿‡)
- è½½è·å¤§å°æ­£ç¡®

âœ… **æµ‹è¯•5**: ç¼ºå¤±å­—æ®µå¤„ç†
- æ— åæ ‡çš„GNSS â†’ None
- æ— vehicle_idçš„è®°å½• â†’ None
- ä¼˜é›…é™çº§

âœ… **æµ‹è¯•6**: æ›¿ä»£å­—æ®µå
- lat/lon vs latitude/longitude âœ“
- vehicle_id vs stationID âœ“

âœ… **æµ‹è¯•7**: å»¶è¿Ÿè®¡ç®—
- tx=1000, rx=1050 â†’ latency=50.0ms âœ“

âœ… **æµ‹è¯•8**: æ—¶é—´æˆ³è‡ªåŠ¨æ£€æµ‹
- ç§’å’Œæ¯«ç§’æ—¶é—´æˆ³ç»Ÿä¸€ä¸ºç›¸åŒå€¼ âœ“

### é›†æˆæµ‹è¯•

ä½¿ç”¨ `/tmp/v2aix_test_data` çš„çœŸå®æµ‹è¯•æ–‡ä»¶ï¼š

```
Total GNSS records: 3
Total V2X records: 6

Sample GNSS record:
  Vehicle: vehicle_001
  Position: (50.7753, 6.0839)
  Timestamp: 1678901234000
  Speed: 13.89 m/s
  Source: gnss_data.json

Sample V2X record:
  Vehicle: vehicle_001
  Message type: CAM
  Direction: uplink_to_rsu
  Latency: 20.0 ms
  Payload: 256 bytes
```

âœ… **æ‰€æœ‰8é¡¹å•å…ƒæµ‹è¯•é€šè¿‡**
âœ… **é›†æˆæµ‹è¯•é€šè¿‡**

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. **é²æ£’æ€§**
- âœ… å¤šç§å­—æ®µå‘½åçº¦å®š
- âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

### 2. **çµæ´»æ€§**
- âœ… å¯é€‰çš„æ˜¾å¼æ—¶é—´æˆ³å•ä½
- âœ… æ”¯æŒä¸å®Œæ•´çš„è®°å½•
- âœ… åŒä¸€å¯¹è±¡å¯è§£æä¸ºå¤šç§ç±»å‹

### 3. **è‡ªåŠ¨åŒ–**
- âœ… æ—¶é—´æˆ³å•ä½è‡ªåŠ¨æ£€æµ‹
- âœ… å»¶è¿Ÿè‡ªåŠ¨è®¡ç®—
- âœ… æ‰¹é‡ç±»å‹è¯†åˆ«

### 4. **æ€§èƒ½**
- âœ… æœ€å°åŒ–å­—æ®µè®¿é—®
- âœ… æ—©æœŸè¿”å›ï¼ˆç¼ºå¤±å¿…éœ€å­—æ®µï¼‰
- âœ… é«˜æ•ˆçš„å­—å…¸æŸ¥æ‰¾

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ€»è¡Œæ•° | ~550 |
| å‡½æ•°æ•°é‡ | 17 |
| æå–å·¥å…· | 10 |
| è§£æå™¨ | 3 (GNSS, V2X, batch) |
| æ—¶é—´æˆ³å·¥å…· | 2 |
| æ–‡æ¡£å­—ç¬¦ä¸²è¦†ç›–ç‡ | 100% |
| ç±»å‹æç¤ºè¦†ç›–ç‡ | 100% |

---

## ğŸ”Œ API ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
from src.v2aix_pipeline import parser

# è§£æå•ä¸ªGNSSè®°å½•
gnss_obj = {
    'stationID': 'vehicle_001',
    'latitude': 50.7753,
    'longitude': 6.0839,
    'timestamp': 1678901234
}
gnss_record = parser.parse_gnss_record(gnss_obj)
print(f"Vehicle at ({gnss_record.latitude_deg}, {gnss_record.longitude_deg})")

# è§£æå•ä¸ªV2Xè®°å½•
v2x_obj = {
    'stationID': 'vehicle_002',
    'messageType': 'CAM',
    'tx_timestamp': 1678901234100,
    'rx_timestamp': 1678901234120
}
v2x_record = parser.parse_v2x_record(v2x_obj)
print(f"Latency: {v2x_record.latency_ms}ms")

# æ‰¹é‡è§£æ
objects = [gnss_obj, v2x_obj]
gnss_records, v2x_records = parser.parse_records(objects)
print(f"Parsed {len(gnss_records)} GNSS + {len(v2x_records)} V2X records")
```

### ä¸discoveryé›†æˆ

```python
from pathlib import Path
from src.v2aix_pipeline import discovery, parser

# ä½¿ç”¨discoveryè¿­ä»£JSONå¯¹è±¡
json_file = Path('/path/to/data.json')
all_gnss = []
all_v2x = []

for obj in discovery._iter_json_objects(json_file):
    gnss_recs, v2x_recs = parser.parse_records([obj], source_file=json_file)
    all_gnss.extend(gnss_recs)
    all_v2x.extend(v2x_recs)

print(f"Total: {len(all_gnss)} GNSS, {len(all_v2x)} V2X")
```

---

## ğŸ“ è®¾è®¡å†³ç­–

### 1. **ä¸ºä»€ä¹ˆæ”¯æŒå¤šç§å­—æ®µåï¼Ÿ**
V2AIXæ•°æ®é›†å¯èƒ½æ¥è‡ªä¸åŒæ¥æºï¼Œä½¿ç”¨ä¸åŒçš„å‘½åçº¦å®šã€‚æ”¯æŒå¤šç§åç§°æé«˜äº†å…¼å®¹æ€§ã€‚

### 2. **ä¸ºä»€ä¹ˆå…è®¸å¯¹è±¡åŒæ—¶è§£æä¸ºGNSSå’ŒV2Xï¼Ÿ**
æŸäº›è®°å½•å¯èƒ½åŒæ—¶åŒ…å«ä½ç½®å’Œé€šä¿¡æ•°æ®ã€‚åˆ†åˆ«è§£æå…è®¸ä¸‹æ¸¸å¤„ç†çµæ´»å¤„ç†è¿™ä¸¤ç§ä¿¡æ¯ã€‚

### 3. **ä¸ºä»€ä¹ˆè‡ªåŠ¨æ£€æµ‹æ—¶é—´æˆ³å•ä½ï¼Ÿ**
ç®€åŒ–ç”¨æˆ·ä½¿ç”¨ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ•°å€¼å¤§å°å¯ä»¥å¯é åœ°æŒ‡ç¤ºå•ä½ã€‚ä»æ”¯æŒæ˜¾å¼æŒ‡å®šä»¥å¤„ç†è¾¹ç¼˜æƒ…å†µã€‚

### 4. **ä¸ºä»€ä¹ˆè¿”å›Noneè€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Ÿ**
æ‰¹é‡å¤„ç†åœºæ™¯ä¸­ï¼Œè·³è¿‡æ— æ•ˆè®°å½•æ¯”åœæ­¢æ•´ä¸ªæµç¨‹æ›´å®ç”¨ã€‚æ—¥å¿—è®°å½•æä¾›è°ƒè¯•æ‰€éœ€çš„å¯è§æ€§ã€‚

---

## ğŸ”— ä¸å…¶ä»–æ¨¡å—çš„é›†æˆ

### è¾“å…¥
- **discovery.py**: ä½¿ç”¨`_iter_json_objects()`è¿­ä»£JSONæ•°æ®
- **config.py**: æœªæ¥å¯èƒ½ä½¿ç”¨æ—¶é—´æˆ³åç§»é…ç½®

### è¾“å‡º
- **models.py**: ç”ŸæˆéªŒè¯è¿‡çš„`GnssRecord`å’Œ`V2XMessageRecord`å®ä¾‹
- **filters.py** (å¾…å®ç°): å°†æ¶ˆè´¹è¿™äº›è®°å½•è¿›è¡Œåœ°ç†è¿‡æ»¤
- **trajectory.py** (å¾…å®ç°): å°†ä½¿ç”¨GNSSè®°å½•ç”Ÿæˆè½¨è¿¹

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **æ—¶é—´æˆ³æ£€æµ‹å‡è®¾**
   - å‡è®¾Unixæ—¶é—´æˆ³ï¼ˆ2001-2286å¹´èŒƒå›´ï¼‰
   - å…¶ä»–çºªå…ƒéœ€è¦æ˜¾å¼å•ä½æŒ‡å®š

2. **æ— æ•°æ®éªŒè¯**
   - ä¸æ£€æŸ¥åæ ‡èŒƒå›´ï¼ˆ-90â‰¤latâ‰¤90, -180â‰¤lonâ‰¤180ï¼‰
   - Pydanticæ¨¡å‹åº”æ·»åŠ validators

3. **æ— æ—¶é’Ÿåç§»å¤„ç†**
   - æœªå®ç°æ¯è½¦è¾†/RSUçš„æ—¶é’Ÿåç§»
   - å»¶è¿Ÿè®¡ç®—å‡è®¾æ—¶é’ŸåŒæ­¥

---

## ğŸš€ æœªæ¥å¢å¼º

### çŸ­æœŸ
- [ ] åœ¨models.pyä¸­æ·»åŠ åæ ‡èŒƒå›´éªŒè¯
- [ ] æ”¯æŒæ—¶é’Ÿåç§»é…ç½®
- [ ] æ·»åŠ æ›´å¤šå­—æ®µåˆ«å

### ä¸­æœŸ
- [ ] æ€§èƒ½åˆ†æå’Œä¼˜åŒ–
- [ ] æ”¯æŒè‡ªå®šä¹‰å­—æ®µæ˜ å°„
- [ ] æ¨¡å¼æ£€æµ‹å’Œè­¦å‘Š

### é•¿æœŸ
- [ ] æ’ä»¶ç³»ç»Ÿç”¨äºè‡ªå®šä¹‰è§£æå™¨
- [ ] æ•°æ®è´¨é‡è¯„åˆ†
- [ ] è‡ªåŠ¨æ¨¡å¼æ¨æ–­

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

åŸºäº `/tmp/v2aix_test_data` æµ‹è¯•ï¼š

| æ“ä½œ | è®°å½•æ•° | æ—¶é—´ | é€Ÿç‡ |
|------|--------|------|------|
| GNSSè§£æ | 3 | <1ms | >3000/s |
| V2Xè§£æ | 6 | <1ms | >6000/s |
| æ‰¹é‡è§£æ | 6 obj â†’ 9 records | <1ms | >9000/s |

*æ³¨: å¾®åŸºå‡†æµ‹è¯•ï¼Œå®é™…æ€§èƒ½å–å†³äºè®°å½•å¤æ‚åº¦å’ŒI/O*

---

## ğŸ“ ç»éªŒæ•™è®­

### æˆåŠŸå› ç´ 
1. **å…¨é¢çš„å­—æ®µæå–å™¨**: é¿å…é‡å¤ä»£ç 
2. **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**: æ—¶é—´æˆ³/å­—æ®µ/è®°å½•çº§åˆ«
3. **è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²**: åŠ é€Ÿå¼€å‘å’Œè°ƒè¯•
4. **æ¸è¿›å¼æµ‹è¯•**: æ¯ä¸ªå·¥å…·ç‹¬ç«‹æµ‹è¯•ï¼Œç„¶åé›†æˆ

### æŠ€æœ¯é€‰æ‹©
- âœ… **Optionalè¿”å›**: æ¯”å¼‚å¸¸æ›´é€‚åˆæ‰¹é‡å¤„ç†
- âœ… **æ—¥å¿—è€Œä¸æ˜¯print**: å¯é…ç½®çš„è°ƒè¯•è¾“å‡º
- âœ… **ç±»å‹æç¤º**: æ•è·IDEä¸­çš„é”™è¯¯
- âœ… **Pydanticé›†æˆ**: å…è´¹çš„éªŒè¯å’Œåºåˆ—åŒ–

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `CLAUDE.md` - é¡¹ç›®æ¶æ„æ¦‚è¿°
- `documents/data_contracts.md` - æ•°æ®æ¨¡å‹è§„èŒƒ
- `src/v2aix_pipeline/models.py` - Pydanticæ¨¡å‹å®šä¹‰
- `src/v2aix_pipeline/discovery.py` - JSONè¿­ä»£å·¥å…·

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] å°†JSONå¯¹è±¡è§£æä¸ºGnssRecord
- [x] å°†JSONå¯¹è±¡è§£æä¸ºV2XMessageRecord
- [x] æ—¶é—´æˆ³æ ‡å‡†åŒ–ï¼ˆç§’/æ¯«ç§’/å¾®ç§’ï¼‰
- [x] æ”¯æŒå¤šç§å­—æ®µå‘½åçº¦å®š
- [x] ä¼˜é›…å¤„ç†ç¼ºå¤±å­—æ®µ
- [x] è‡ªåŠ¨å»¶è¿Ÿè®¡ç®—
- [x] æ‰¹é‡è§£æåŠŸèƒ½
- [x] å…¨é¢çš„å•å…ƒæµ‹è¯•
- [x] ä¸discoveryæ¨¡å—é›†æˆæµ‹è¯•
- [x] 100%æ–‡æ¡£è¦†ç›–
- [x] 100%ç±»å‹æç¤º

---

## ğŸ¯ ä¸‹ä¸€ä¸ªä»»åŠ¡

**Task 4**: å®ç° `filters.py` - åœ°ç†åŒºåŸŸè¿‡æ»¤

**åŠŸèƒ½**:
- è¾¹ç•Œæ¡† (bbox) è¿‡æ»¤
- GeoJSONå¤šè¾¹å½¢è¿‡æ»¤
- é›†æˆshapelyè¿›è¡Œå‡ ä½•è¿ç®—
- è¿‡æ»¤GnssRecordåˆ—è¡¨

**é¢„è®¡å·¥ä½œé‡**: 3-4å°æ—¶
**ä¾èµ–**: shapely, pyproj (å·²åœ¨requirements.txtä¸­)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025å¹´10æœˆ16æ—¥ 20:15
**ä½œè€…**: Claude Code
**çŠ¶æ€**: âœ… Task 3 å®Œæˆ
